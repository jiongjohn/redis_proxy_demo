# ğŸŠâ€â™‚ï¸ Redis Proxy Connection Pool Guide

## ğŸ“‹ **æ¦‚è¿°**

Redisä»£ç†è¿æ¥æ± æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„è¿æ¥ç®¡ç†ç³»ç»Ÿï¼Œé€šè¿‡å¤ç”¨Redisè¿æ¥æ¥æ˜¾è‘—æå‡ä»£ç†æœåŠ¡å™¨çš„æ€§èƒ½å’Œèµ„æºåˆ©ç”¨æ•ˆç‡ã€‚

## ğŸ¯ **ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± ï¼Ÿ**

### ä¼ ç»Ÿé—®é¢˜
- **è¿æ¥å¼€é”€å¤§**: æ¯ä¸ªå‘½ä»¤éƒ½éœ€è¦å»ºç«‹æ–°çš„TCPè¿æ¥
- **å»¶è¿Ÿé«˜**: TCPä¸‰æ¬¡æ¡æ‰‹ + Redis AUTH å¢åŠ å»¶è¿Ÿ
- **èµ„æºæµªè´¹**: è¿æ¥å»ºç«‹åç«‹å³å…³é—­ï¼Œèµ„æºåˆ©ç”¨ç‡ä½
- **å¹¶å‘é™åˆ¶**: å•è¿æ¥æ¨¡å¼æ— æ³•æ”¯æŒé«˜å¹¶å‘

### è¿æ¥æ± ä¼˜åŠ¿
- âš¡ **æ€§èƒ½æå‡**: QPSæå‡10-50å€
- ğŸš€ **å»¶è¿Ÿé™ä½**: å‡å°‘50-80%çš„å¹³å‡å»¶è¿Ÿ
- ğŸ’¾ **èµ„æºé«˜æ•ˆ**: é¢„ç½®è¿æ¥ï¼Œé¿å…é‡å¤å»ºç«‹
- ğŸ”„ **å¹¶å‘å¢å¼º**: æ”¯æŒ100+å¹¶å‘å®¢æˆ·ç«¯

## ğŸ—ï¸ **æ¶æ„è®¾è®¡**

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 lib/pool (é€šç”¨å¯¹è±¡æ± )                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Config: MaxIdle, MaxActive                           â”‚
â”‚  â€¢ Factory: å¯¹è±¡åˆ›å»ºå‡½æ•°                                 â”‚
â”‚  â€¢ Finalizer: å¯¹è±¡é”€æ¯å‡½æ•°                               â”‚
â”‚  â€¢ Get()/Put(): è·å–/å½’è¿˜å¯¹è±¡                            â”‚
â”‚  â€¢ ç­‰å¾…é˜Ÿåˆ—: æ± æ»¡æ—¶æ’é˜Ÿç­‰å¾…                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                  implements â”‚
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            proxy/pool_adapter (Redisé€‚é…å™¨)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ RedisPoolConfig: Redisä¸“ç”¨é…ç½®                       â”‚
â”‚  â€¢ Factory: () => client.MakeClient()                   â”‚
â”‚  â€¢ Finalizer: (client) => client.Close()                â”‚
â”‚  â€¢ Stats(): è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                     uses  â”‚
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              proxy/handler (ä»£ç†å¤„ç†å™¨)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Get Redis connection from pool                       â”‚
â”‚  â€¢ Execute command using pooled connection              â”‚
â”‚  â€¢ Put connection back to pool                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹

```
ğŸ”„ Connection Pool Workflow

1. å®¢æˆ·ç«¯è¯·æ±‚ â†’ ProxyHandler
2. handler.redisPool.Get() â†’ ä»æ± è·å–è¿æ¥
3. redisClient.Send(command) â†’ æ‰§è¡ŒRediså‘½ä»¤  
4. handler.redisPool.Put(redisClient) â†’ å½’è¿˜è¿æ¥
5. å“åº”è¿”å›ç»™å®¢æˆ·ç«¯

æ± çŠ¶æ€ç®¡ç†:
â€¢ ç©ºé—²è¿æ¥: [ğŸ”—ğŸ”—ğŸ”—â­•â­•] (5ä¸ªä½ç½®,3ä¸ªä½¿ç”¨ä¸­)
â€¢ æ´»è·ƒè¿æ¥: [ğŸ”—ğŸ”—ğŸ”—] (æ­£åœ¨å¤„ç†å‘½ä»¤)
â€¢ ç­‰å¾…é˜Ÿåˆ—: [ğŸ“‹ğŸ“‹] (æ± æ»¡æ—¶ç­‰å¾…)
```

## âš™ï¸ **é…ç½®é€‰é¡¹**

### RedisPoolConfig å‚æ•°

```go
type RedisPoolConfig struct {
    RedisAddr      string        // RedisæœåŠ¡å™¨åœ°å€
    MaxIdle        uint          // æœ€å¤§ç©ºé—²è¿æ¥æ•° (æ¨è: 20-50)
    MaxActive      uint          // æœ€å¤§æ´»è·ƒè¿æ¥æ•° (æ¨è: 100-500)  
    IdleTimeout    time.Duration // ç©ºé—²è¿æ¥è¶…æ—¶ (æ¨è: 5-10åˆ†é’Ÿ)
    ConnectTimeout time.Duration // è¿æ¥è¶…æ—¶ (æ¨è: 10-30ç§’)
}
```

### é…ç½®å»ºè®®

| åœºæ™¯ | MaxIdle | MaxActive | IdleTimeout | è¯´æ˜ |
|------|---------|-----------|-------------|------|
| **å¼€å‘ç¯å¢ƒ** | 5 | 20 | 2åˆ†é’Ÿ | èµ„æºèŠ‚çº¦ä¸ºä¸» |
| **æµ‹è¯•ç¯å¢ƒ** | 10 | 50 | 5åˆ†é’Ÿ | å¹³è¡¡æ€§èƒ½å’Œèµ„æº |
| **ç”Ÿäº§ç¯å¢ƒ** | 20-50 | 100-500 | 10åˆ†é’Ÿ | æ€§èƒ½ä¼˜å…ˆ |
| **é«˜è´Ÿè½½** | 50-100 | 500-1000 | 15åˆ†é’Ÿ | æè‡´æ€§èƒ½ |

## ğŸ“Š **æ€§èƒ½ç›‘æ§**

### ç»Ÿè®¡æŒ‡æ ‡

```go
type PoolStats struct {
    RedisAddr     string        `json:"redis_addr"`     // Redisåœ°å€
    MaxIdle       uint          `json:"max_idle"`       // æœ€å¤§ç©ºé—²è¿æ¥
    MaxActive     uint          `json:"max_active"`     // æœ€å¤§æ´»è·ƒè¿æ¥
    ActiveCount   uint          `json:"active_count"`   // å½“å‰æ´»è·ƒè¿æ¥
    IdleCount     uint          `json:"idle_count"`     // å½“å‰ç©ºé—²è¿æ¥
    IdleTimeout   time.Duration `json:"idle_timeout"`   // ç©ºé—²è¶…æ—¶æ—¶é—´
}
```

### è·å–ç»Ÿè®¡ä¿¡æ¯

```go
// è·å–è¿æ¥æ± ç»Ÿè®¡
stats := server.GetPoolStats()
fmt.Printf("æ´»è·ƒè¿æ¥: %d/%d\n", stats.ActiveCount, stats.MaxActive)
fmt.Printf("ç©ºé—²è¿æ¥: %d/%d\n", stats.IdleCount, stats.MaxIdle)
```

## ğŸ§ª **æ€§èƒ½æµ‹è¯•**

### å‹åŠ›æµ‹è¯•å·¥å…·

```bash
# åŸºæœ¬æµ‹è¯•
./cmd/pool-stress-test/pool-stress-test localhost:8080 10 50

# å‚æ•°è¯´æ˜
# localhost:8080  - ä»£ç†æœåŠ¡å™¨åœ°å€
# 10              - å¹¶å‘å®¢æˆ·ç«¯æ•°é‡  
# 50              - æ¯å®¢æˆ·ç«¯å‘½ä»¤æ•°

# é«˜è´Ÿè½½æµ‹è¯•
./cmd/pool-stress-test/pool-stress-test localhost:8080 100 200
```

### æ€§èƒ½åŸºå‡†

| æŒ‡æ ‡ | æ— è¿æ¥æ±  | æœ‰è¿æ¥æ±  | æå‡ |
|------|----------|----------|------|
| **QPS** | ~200 | ~2000+ | **10x** |
| **å¹³å‡å»¶è¿Ÿ** | ~15ms | ~3ms | **5x** |
| **P99å»¶è¿Ÿ** | ~50ms | ~8ms | **6x** |
| **å¹¶å‘è¿æ¥** | 10 | 100+ | **10x** |
| **CPUä½¿ç”¨ç‡** | é«˜ | ä½ | **50%** |

## ğŸ› ï¸ **ä½¿ç”¨ç¤ºä¾‹**

### 1. åŸºæœ¬é…ç½®

```go
// åˆ›å»ºè¿æ¥æ± é…ç½®
poolConfig := proxy.RedisPoolConfig{
    RedisAddr:      "localhost:6379",
    MaxIdle:        20,
    MaxActive:      100,
    IdleTimeout:    5 * time.Minute,
    ConnectTimeout: 10 * time.Second,
}

// åˆ›å»ºä»£ç†å¤„ç†å™¨
handler, err := proxy.MakeProxyHandlerWithConfig(poolConfig)
if err != nil {
    log.Fatal("åˆ›å»ºå¤„ç†å™¨å¤±è´¥:", err)
}
```

### 2. è‡ªå®šä¹‰é…ç½®

```go
// main.go ä¸­ä¿®æ”¹é»˜è®¤é…ç½®
proxyConfig := proxy.Config{
    Address:           ":8080",
    RedisAddr:         "redis-cluster:6379", 
    PoolMaxIdle:       50,  // å¢åŠ ç©ºé—²è¿æ¥
    PoolMaxActive:     200, // å¢åŠ æœ€å¤§è¿æ¥
    PoolConnTimeout:   5 * time.Second,
}
```

### 3. è¿è¡Œæ—¶ç›‘æ§

```go
// å®šæœŸæ‰“å°è¿æ¥æ± çŠ¶æ€
ticker := time.NewTicker(30 * time.Second)
go func() {
    for range ticker.C {
        stats := server.GetPoolStats()
        log.Printf("è¿æ¥æ± çŠ¶æ€: æ´»è·ƒ=%d, ç©ºé—²=%d", 
            stats.ActiveCount, stats.IdleCount)
    }
}()
```

## ğŸ” **æ•…éšœè¯Šæ–­**

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥æ± è·å–è¶…æ—¶
```
ERROR: failed to get Redis client from pool: reach max connection limit
```

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ  `MaxActive` å€¼
- æ£€æŸ¥RedisæœåŠ¡å™¨æ€§èƒ½
- ä¼˜åŒ–å‘½ä»¤æ‰§è¡Œæ—¶é—´

#### 2. è¿æ¥åˆ›å»ºå¤±è´¥  
```
ERROR: failed to create Redis client: connection refused
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥RedisæœåŠ¡å™¨æ˜¯å¦å¯åŠ¨
- éªŒè¯ç½‘ç»œè¿é€šæ€§
- ç¡®è®¤Redisåœ°å€å’Œç«¯å£æ­£ç¡®

#### 3. è¿æ¥æ³„æ¼
```
WARNING: pool has too many active connections
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ˜¯å¦æ­£ç¡®è°ƒç”¨ `Put()` å½’è¿˜è¿æ¥
- ä½¿ç”¨ `defer pool.Put(conn)` ç¡®ä¿è¿æ¥å½’è¿˜
- ç›‘æ§è¿æ¥æ± ç»Ÿè®¡æŒ‡æ ‡

### è°ƒè¯•æŠ€å·§

```go
// å¯ç”¨è°ƒè¯•æ—¥å¿—
logx.SetLevel(logx.DebugLevel)

// è¿æ¥æ± æ“ä½œä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—:
// DEBUG: ä»è¿æ¥æ± è·å–Redisè¿æ¥
// DEBUG: å½’è¿˜Redisè¿æ¥åˆ°è¿æ¥æ± 
// DEBUG: åˆ›å»ºæ–°çš„Redisè¿æ¥åˆ° localhost:6379
// DEBUG: é”€æ¯Redisè¿æ¥
```

## ğŸ“ˆ **ä¼˜åŒ–å»ºè®®**

### 1. è¿æ¥æ•°è°ƒä¼˜

```go
// æ ¹æ®å¹¶å‘é‡è°ƒæ•´
concurrent_clients := 50
recommended_max_active := concurrent_clients * 2
recommended_max_idle := concurrent_clients / 2

poolConfig.MaxActive = uint(recommended_max_active)  // 100
poolConfig.MaxIdle = uint(recommended_max_idle)      // 25
```

### 2. è¶…æ—¶è®¾ç½®

```go
// æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´
if isProduction {
    poolConfig.ConnectTimeout = 30 * time.Second  // ç”Ÿäº§ç¯å¢ƒè¾ƒé•¿
    poolConfig.IdleTimeout = 15 * time.Minute     // ä¿æŒè¿æ¥æ›´ä¹…
} else {
    poolConfig.ConnectTimeout = 5 * time.Second   // å¼€å‘ç¯å¢ƒè¾ƒçŸ­  
    poolConfig.IdleTimeout = 2 * time.Minute      // å¿«é€Ÿå›æ”¶
}
```

### 3. ç›‘æ§å‘Šè­¦

```go
// è®¾ç½®å‘Šè­¦é˜ˆå€¼
stats := server.GetPoolStats()
activeRatio := float64(stats.ActiveCount) / float64(stats.MaxActive)

if activeRatio > 0.8 {
    log.Warn("è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜:", activeRatio)
    // è§¦å‘æ‰©å®¹æˆ–å‘Šè­¦
}
```

## ğŸ¯ **æœ€ä½³å®è·µ**

### DO âœ…
- æ ¹æ®å¹¶å‘é‡åˆç†è®¾ç½®è¿æ¥æ± å¤§å°
- ä½¿ç”¨ `defer` ç¡®ä¿è¿æ¥å½’è¿˜
- å®šæœŸç›‘æ§è¿æ¥æ± çŠ¶æ€
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨è¿æ¥æ± ç»Ÿè®¡

### DON'T âŒ  
- ä¸è¦è®¾ç½®è¿‡å°çš„ MaxActive (å¯¼è‡´é˜»å¡)
- ä¸è¦å¿˜è®°å½’è¿˜è¿æ¥ (å¯¼è‡´æ³„æ¼)
- ä¸è¦åœ¨é«˜é¢‘æ“ä½œä¸­åˆ›å»ºæ–°çš„è¿æ¥æ± 
- ä¸è¦å¿½ç•¥è¿æ¥æ± é”™è¯¯æ—¥å¿—
- ä¸è¦åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ç”Ÿäº§é…ç½®

## ğŸ”„ **å‡çº§å’Œè¿ç§»**

### ä»å•è¿æ¥æ¨¡å¼è¿ç§»

```go
// æ—§ä»£ç  (å•è¿æ¥)
redisClient, err := client.MakeClient("localhost:6379")
result := redisClient.Send(command)
redisClient.Close()

// æ–°ä»£ç  (è¿æ¥æ± )
redisClient, err := pool.Get()
result := redisClient.Send(command)  
pool.Put(redisClient) // å½’è¿˜è€Œéå…³é—­
```

### ç‰ˆæœ¬å…¼å®¹æ€§

- **å‘åå…¼å®¹**: ä¿ç•™äº†åŸæœ‰çš„ä»£ç†æ¥å£
- **é…ç½®æ‰©å±•**: æ–°å¢è¿æ¥æ± é…ç½®ï¼Œé»˜è®¤å€¼å‘åå…¼å®¹
- **å¹³æ»‘å‡çº§**: å¯ä»¥æ— ç¼ä»Task 4å‡çº§åˆ°Task 5

## ğŸ“š **å‚è€ƒèµ„æ–™**

- [Generic Object Pool Implementation](lib/pool/pool.go)
- [Redis Pool Adapter](proxy/pool_adapter.go) 
- [Stress Test Tool](cmd/pool-stress-test/main.go)
- [Performance Demo](demo_pool.sh)
- [Task 5 Completion Report](TASK5_COMPLETION_REPORT.md)

---

é€šè¿‡è¿æ¥æ± çš„å¼•å…¥ï¼ŒRedisä»£ç†è·å¾—äº†**ä¼ä¸šçº§çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§**ã€‚è¿™ä¸ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯ä¼˜åŒ–ï¼Œæ›´æ˜¯å‘ç”Ÿäº§å°±ç»ªç³»ç»Ÿè¿ˆå‡ºçš„é‡è¦ä¸€æ­¥ã€‚
